<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/style.css" />
    <title>random park spin</title>
    <link rel="manifest" href="manifest.json" />
  </head>
  <body>
    <div class="container py-5 my-md-5">
      <div class="row align-items-center text-center justify-content-evenly">
        <div class="col-12">
          <img class="img-fluid mb-3" src="./img/icon/mv.png" alt="symbol" />
          <h5 class="mb-4">DBDM用 ランダムパークチャレンジ</h5>
        </div>
        <div class="col-4 col-md-3">
          <a href="./" class="text-decoration-none text-white"
            ><p class="mb-0 fw-bold text-decoration-underline">サバイバー</p>
            <img class="img-fluid mb-3" src="./img/icon/sub.png" alt="symbol" />
          </a>
        </div>
        <div class="col-4 col-md-3">
          <a href="./killar.html" class="text-decoration-none text-white"
            ><p class="mb-0">キラー</p>
            <img class="img-fluid mb-3" src="./img/icon/kill.png" alt="symbol"
          /></a>
        </div>
        <hr />
        <div class="col-12">
          <div class="row align-items-center text-center">
            <div class="col-6 col-md-3 py-md-5" id="reel1">
              <img class="symbol-img" src="./img/dbd.png" alt="symbol" />
              <p class="symbol-text mt-2 mb-0 text-center fw-bold">---</p>
              <p class="user mt-1 mb-0 text-center small">---</p>
              <p class="type mt-0 text-center small">---</p>
            </div>
            <div class="col-6 col-md-3 py-md-5" id="reel2">
              <img class="symbol-img" src="./img/dbd.png" alt="symbol" />
              <p class="symbol-text mt-2 mb-0 fw-bold">---</p>
              <p class="user mt-1 mb-0 text-center small">---</p>
              <p class="type mt-0 text-center small">---</p>
            </div>
            <div class="col-6 col-md-3 py-md-5" id="reel3">
              <img class="symbol-img" src="./img/dbd.png" alt="symbol" />
              <p class="symbol-text mt-2 mb-0 text-center fw-bold">---</p>
              <p class="user mt-1 mb-0 text-center small">---</p>
              <p class="type mt-0 text-center small">---</p>
            </div>
            <div class="col-6 col-md-3 py-md-5" id="reel4">
              <img class="symbol-img" src="./img/dbd.png" alt="symbol" />
              <p class="symbol-text mt-2 mb-0 text-center fw-bold">---</p>
              <p class="user mt-1 mb-0 text-center small">---</p>
              <p class="type mt-0 text-center small">---</p>
            </div>
          </div>
        </div>

        <div class="col-12 mb-3">
          <button id="spin-button">スタート＆ストップ</button>
        </div>
      </div>
      <hr />
      <div class="row align-items-center text-start">
        <div class="col-12">
          <p id="symbol-text-display" class="mb-4"></p>
        </div>
      </div>
      <hr />
      <div class="row align-items-center text-center">
        <div class="col-12 mb-0 mt-5">
          <p class="mb-0">
            チェックを入れたキャラのパークが<br />ルーレット対象になるよ
          </p>
        </div>
        <div class="col-12 my-3 mb-3">
          <button id="check-all-button">全てチェック</button>
          <button id="uncheck-all-button">リセット</button>
          <button id="remember-button">選択状態を記憶</button>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="common"
              id="common"
            />
            <label class="form-check-label" for="common"> 共通パーク </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="dowa"
              id="dowa"
            />
            <label class="form-check-label" for="dowa"> ドワイト </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="megu"
              id="megu"
            />
            <label class="form-check-label" for="megu"> メグ </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="kuro"
              id="kuro"
            />
            <label class="form-check-label" for="kuro"> クローデット </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="bill"
              id="bill"
            />
            <label class="form-check-label" for="bill"> ビル </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="jake"
              id="jake"
            />
            <label class="form-check-label" for="jake"> ジェイク </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="nea"
              id="nea"
            />
            <label class="form-check-label" for="nea"> ネア </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="ace"
              id="ace"
            />
            <label class="form-check-label" for="ace"> エース </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="kate"
              id="kate"
            />
            <label class="form-check-label" for="kate"> ケイト </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="davi"
              id="davi"
            />
            <label class="form-check-label" for="davi">
              デイビッド・キング
            </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="fen"
              id="fen"
            />
            <label class="form-check-label" for="fen"> フェンミン </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="jef"
              id="jef"
            />
            <label class="form-check-label" for="jef"> ジェフ </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="kimura"
              id="kimura"
            />
            <label class="form-check-label" for="kimura"> 木村結衣 </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="jane"
              id="jane"
            />
            <label class="form-check-label" for="jane">
              ジェーン・ロメロ
            </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="roll"
              id="roll"
            />
            <label class="form-check-label" for="roll"> ローリー </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="hady"
              id="hady"
            />
            <label class="form-check-label" for="hady"> ハディ・カウル </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="ero"
              id="ero"
            />
            <label class="form-check-label" for="ero"> エロディー </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="rena"
              id="rena"
            />
            <label class="form-check-label" for="rena"> レナート </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="feri"
              id="feri"
            />
            <label class="form-check-label" for="feri">
              フェリックス・リクター
            </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="gabu"
              id="gabu"
            />
            <label class="form-check-label" for="gabu"> ガブリエル </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="zal"
              id="zal"
            />
            <label class="form-check-label" for="zal"> ザリーナ </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="bit"
              id="bit"
            />
            <label class="form-check-label" for="bit"> ビットリオ </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="que"
              id="que"
            />
            <label class="form-check-label" for="que"> クエンティン </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="ash"
              id="ash"
            />
            <label class="form-check-label" for="ash"> アシュレイ・J </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="adom"
              id="adom"
            />
            <label class="form-check-label" for="adom"> アダム </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="jona"
              id="jona"
            />
            <label class="form-check-label" for="jona">
              ジョナ・バスケス
            </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="tap"
              id="tap"
            />
            <label class="form-check-label" for="tap"> タップ刑事 </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="taly"
              id="taly"
            />
            <label class="form-check-label" for="taly"> タリータ </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="nico"
              id="nico"
            />
            <label class="form-check-label" for="nico"> ニコラス </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="asa"
              id="asa"
            />
            <label class="form-check-label" for="asa"> 浅川陽一 </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="lee"
              id="lee"
            />
            <label class="form-check-label" for="lee"> リー・ユンジン </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="mika"
              id="mika"
            />
            <label class="form-check-label" for="mika"> ミカエラ </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="buy"
              id="buy"
            />
            <label class="form-check-label" for="buy"> 購入パーク </label>
          </div>
        </div>
        <div class="col-auto p-2 px-3">
          <div class="form-check">
            <input
              class="form-check-input symbol-group"
              type="checkbox"
              value="seburu"
              id="seburu"
            />
            <label class="form-check-label" for="seburu"> セーブル </label>
          </div>
        </div>
      </div>
    </div>

    <script>
      document
        .getElementById("remember-button")
        .addEventListener("click", () => {
          const checkedGroups = Array.from(
            document.querySelectorAll(".symbol-group:checked")
          ).map((el) => el.value);

          localStorage.setItem("checkedGroups", JSON.stringify(checkedGroups));
          alert("チェックしたグループが記憶されました。");
        });

      const reels = [
        document.getElementById("reel1"),
        document.getElementById("reel2"),
        document.getElementById("reel3"),
        document.getElementById("reel4"),
      ];

      const spinReel = (reel, availableSymbols) => {
        return new Promise((resolve) => {
          let count = 0;
          const interval = setInterval(() => {
            const symbol =
              availableSymbols[
                Math.floor(Math.random() * availableSymbols.length)
              ];
            reel.querySelector(".symbol-img").src = symbol.img;
            reel.querySelector(".symbol-text").textContent = symbol.text;
            reel.querySelector(".user").textContent = symbol.user;
            reel.querySelector(".type").textContent = symbol.type;
            if (count > 30) {
              clearInterval(interval);
              resolve(symbol);
            }
            count++;
          }, 20);
        });
      };

      document
        .getElementById("spin-button")
        .addEventListener("click", async () => {
          document.getElementById("spin-button").disabled = true;

          const checkedGroups = Array.from(
            document.querySelectorAll(".symbol-group:checked")
          ).map((el) => el.value);

          const availableSymbols = symbols.filter((symbol) =>
            checkedGroups.includes(symbol.group)
          );

          let showAlert = false;

          const usedSymbols = [];
          const selectedSymbolsText = [];

          for (const reel of reels) {
            const symbolsForReel = availableSymbols.filter(
              (symbol) =>
                !usedSymbols.some((usedSymbol) => usedSymbol.img === symbol.img)
            );

            if (symbolsForReel.length === 0) {
              if (!showAlert) {
                alert("選択されたグループに対応するシンボルがありません。");
                showAlert = true;
              }
              continue;
            }

            const symbol = await spinReel(reel, symbolsForReel);
            usedSymbols.push(symbol);

            let textWithKana = symbol.text;
            if (symbol.kana) {
              textWithKana += " (" + symbol.kana + ")";
            }

            selectedSymbolsText.push(
              '<span class="fw-bold">' +
                textWithKana +
                ": </span><br><small>" +
                symbol.explain +
                "</small><br>"
            );
          }

          const symbolTextElement = document.getElementById(
            "symbol-text-display"
          );
          if (symbolTextElement) {
            symbolTextElement.innerHTML = selectedSymbolsText.join("<br>");
          }

          document.getElementById("spin-button").disabled = false;
        });

      document
        .getElementById("check-all-button")
        .addEventListener("click", () => {
          const checkboxes = document.querySelectorAll(".symbol-group");
          checkboxes.forEach((checkbox) => {
            checkbox.checked = true;
          });
        });

      document
        .getElementById("uncheck-all-button")
        .addEventListener("click", () => {
          const checkboxes = document.querySelectorAll(".symbol-group");
          checkboxes.forEach((checkbox) => {
            checkbox.checked = false;
          });
        });

      window.addEventListener("load", () => {
        const savedGroups = JSON.parse(localStorage.getItem("checkedGroups"));
        if (savedGroups) {
          savedGroups.forEach((group) => {
            const checkbox = document.querySelector(
              `.symbol-group[value="${group}"]`
            );
            console.log(checkbox);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
        }
      });

      // PWAがホーム画面から起動された場合
      if (window.matchMedia("(display-mode: standalone)").matches) {
        window.addEventListener("load", () => {
          if (!sessionStorage.getItem("reloaded")) {
            sessionStorage.setItem("reloaded", "true");
            window.location.reload();
          }
        });
      }
    </script>
    <script src="./js/constants-survivor.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
